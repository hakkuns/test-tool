# Testing Assistant Suite 使い方

## 概要

Testing Assistant Suite は、PostgreSQL データベースと API のテストを効率化するためのツールです。テストシナリオを作成し、テーブル定義、テストデータ、モック API を統合管理できます。

## 主な機能

### 1. テストシナリオ管理

テストシナリオを作成・編集・削除できます。各シナリオには以下の要素を設定できます：

- **基本情報**: シナリオ名、説明、タグ
- **対象 API**: テスト対象の API エンドポイント（HTTP メソッド、URL）
- **テスト設定**: デフォルトの Headers/Body 設定（定数機能を含む）
- **テーブル定義**: DDL でテーブル構造を定義
- **テストデータ**: テーブルに投入するデータ
- **モック API**: 外部 API の振る舞いをシミュレート
- **期待レスポンス**: API レスポンスの検証用データ

### 2. グループ管理

関連するシナリオをグループ化して整理できます：

- グループの作成・編集・削除
- グループ間でのシナリオの移動
- グループごとのフィルタリング表示
- グループ単位でのインポート/エクスポート

### 3. お気に入り機能

よく使うシナリオを⭐お気に入りに登録して、すばやくアクセスできます。お気に入りのシナリオは一覧の上位に表示されます。

### 4. タグ検索

シナリオにタグを付けて、効率的に検索・フィルタリングできます（例: `smoke-test`, `regression`, `critical`）。

### 5. データベース接続

PostgreSQL データベースに接続し、テーブルの作成やデータの投入を自動化します。ナビゲーションバーに接続状態が表示されます：

- 🟢 **接続中**: データベースに正常に接続されています
- 🔴 **未接続**: データベースに接続できていません（設定画面で接続情報を確認してください）

## 基本的な使い方

### シナリオの作成

1. ホーム画面右上の「**新規作成**」ボタンをクリック
2. 基本情報を入力
   - シナリオ名（必須）
   - 説明（任意）
   - グループ（任意）
   - タグ（任意、カンマ区切りで複数設定可能）
3. 対象 API を設定
   - HTTP メソッド（GET、POST、PUT、DELETE、PATCH 等）
   - URL（例: `http://localhost:8080/api/users`）
4. テスト設定を入力（任意）
   - デフォルトの Headers（例: `Authorization`, `Content-Type`）
   - デフォルトの Body（JSON 形式）
   - **定数機能**: `$TIMESTAMP`, `$UUID`, `$RANDOM_INT` 等の定数を使用可能
5. 必要に応じてテーブル定義、データ、モック API を追加
6. 「**保存**」ボタンで保存

### テーブル定義の追加

1. 「テーブル定義」セクションで「**追加**」をクリック
2. テーブル名を入力
3. DDL（CREATE TABLE 文）を入力
4. 依存関係がある場合は、依存するテーブルを選択（外部キー制約がある場合に重要）

### テストデータの追加

1. 「テーブルデータ」セクションで「**テーブルを追加**」をクリック
2. 対象テーブルを選択
3. 「**行を追加**」で各レコードを入力
4. 投入前にテーブルをクリアする場合は「投入前にテーブルをクリア」をチェック

### モック API の追加

1. 「モック API」セクションで「**追加**」をクリック
2. 基本設定
   - 名前（任意、管理用）
   - HTTP メソッド
   - パス（例: `/users/:id`）
   - 優先度（数値が大きいほど優先、デフォルト: 0）
3. レスポンス設定
   - ステータスコード（例: 200, 404, 500）
   - ヘッダー（例: `Content-Type: application/json`）
   - ボディ（JSON 形式）
4. マッチング条件（任意）
   - リクエストヘッダー条件
   - リクエストボディ条件（JSON 形式）

### 定数機能の使用

テスト設定やモック API のレスポンスで、以下の定数を使用できます：

- `$TIMESTAMP`: 現在時刻のタイムスタンプ（ミリ秒）
- `$UUID`: ランダムなUUID
- `$RANDOM_INT`: ランダムな整数（0〜9999）
- `$DATE`: 現在日付（YYYY-MM-DD形式）
- `$TIME`: 現在時刻（HH:mm:ss形式）

例:
```json
{
  "id": "$UUID",
  "createdAt": "$TIMESTAMP",
  "userId": "$RANDOM_INT"
}
```

API Test ページで「定数を再変換」ボタンをクリックすると、定数が新しい値に更新されます。

### モック API の使用

作成したモック API のエンドポイント URL は以下の形式です：

```
http://localhost:3001/api/mock/serve/{パス}
```

例えば、モック API で `/users` というパスを設定した場合、実際のエンドポイントは：

```
http://localhost:3001/api/mock/serve/users
```

テスト対象のアプリケーションで、この URL を設定してモック API を利用してください。

**重要**: アプリケーション側で API のベース URL を変更する必要があります。

**⚠️ devContainer からモック API に接続する場合:**

devContainer 内で動作するアプリケーションからモック API に接続する場合、`localhost` の代わりに `host.docker.internal` を使用してください。

例:
```
http://host.docker.internal:3001/api/mock/serve/users
```

これにより、devContainer からホストマシン上で動作している Testing Assistant Suite のモック API に正しくアクセスできます。

### シナリオの実行

1. **API Test** ページを開く
2. グループフィルターでグループを選択（オプション）
3. シナリオドロップダウンから使用するシナリオを選択
4. 「**適用**」ボタンをクリック
   - テーブル作成
   - データ投入
   - モック API 設定
   が自動実行されます
5. リクエストフォームにテスト設定が自動入力される
6. 必要に応じて Headers/Body を動的に変更
7. **GET/DELETE メソッドの場合**: Body タブが自動的に無効化されます
8. 「**Send Request**」でテスト実行
9. レスポンスを確認

### curl コマンドのコピー

API Test ページのリクエストフォームから curl コマンドをコピーできます：

1. リクエスト設定を入力
2. ヘッダー右上の「**curl**」ボタンをクリック
3. curl コマンドがクリップボードにコピーされます
4. ターミナルで実行可能な形式で生成されます

### リクエスト履歴

API Test ページでは、過去のリクエスト履歴を確認・再実行できます：

- 最大50件まで自動保存
- 各履歴からワンクリックで再実行可能
- 個別削除または全削除が可能

## インポート・エクスポート

### シナリオのエクスポート

個別のシナリオまたは全シナリオを JSON 形式でエクスポートできます：

**個別エクスポート**:
1. ホーム画面のシナリオカードで「**︙**」メニューをクリック
2. 「**エクスポート**」を選択（Downloadアイコン）
3. JSON ファイルがダウンロードされます

**全シナリオエクスポート**:
1. ホーム画面右上の「**全シナリオをエクスポート**」ボタンをクリック
2. すべてのシナリオを含む JSON ファイルがダウンロードされます

### シナリオのインポート

1. ホーム画面右上の「**インポート**」ボタン（Uploadアイコン）をクリック
2. JSON ファイルを選択
3. シナリオが追加されます

### グループのエクスポート

グループ全体（含まれるすべてのシナリオ）をエクスポートできます：

1. グループヘッダーの「**︙**」メニューをクリック
2. 「**グループをエクスポート**」を選択
3. グループとシナリオを含む JSON ファイルがダウンロードされます

### グループのインポート

1. ホーム画面右上の「**グループをインポート**」ボタンをクリック
2. グループエクスポートファイル（JSON）を選択
3. グループとシナリオが一括で追加されます

## シナリオの管理

### グループ化

シナリオをグループに移動するには：

1. シナリオカードの「**︙**」メニューをクリック
2. 「**グループに移動**」を選択
3. 移動先のグループを選択（「未分類」も選択可能）

### お気に入り登録

よく使うシナリオをお気に入りに登録：

1. シナリオカード左上の⭐アイコンをクリック
2. お気に入りに登録されると⭐が塗りつぶされます
3. お気に入りのシナリオはグループ内で上位に表示されます

### シナリオのコピー

既存のシナリオを複製して新しいシナリオを作成：

1. シナリオカードの「**︙**」メニューをクリック
2. 「**コピー**」を選択
3. 「(シナリオ名)のコピー」という名前で複製されます
4. コピー後、自動的にコピー元と同じグループフィルターが適用されます

### シナリオの削除

1. シナリオカードの「**︙**」メニューをクリック
2. 「**削除**」を選択（Trash2アイコン）
3. 確認ダイアログで「削除」をクリック

### 検索とフィルター

ホーム画面では以下の方法でシナリオを絞り込めます：

1. **テキスト検索**: 検索ボックスでシナリオ名や説明を検索
2. **グループフィルター**: ドロップダウンで特定のグループのみ表示
   - 「すべて表示」: すべてのシナリオ
   - 「未分類のみ」: グループに属さないシナリオ
   - 各グループ名: そのグループのシナリオのみ

### テスト結果の記録

API Test ページでシナリオを適用後、テスト結果を記録できます：

1. シナリオカード右下のテスト結果アイコンをクリック
2. 結果を選択：
   - ✅ **成功**: テストが成功
   - ❌ **失敗**: テストが失敗
   - ❓ **未テスト**: テスト未実施
3. 最後にテストした日時も記録されます

### シナリオの再適用

シナリオを編集した後、API Test ページで「**再適用が必要**」バッジが表示されます：

1. 「**適用**」ボタンをクリック
2. 最新の設定でテーブル、データ、モック API が再構築されます

## Tips

- **グループ機能**: 大量のシナリオを扱う場合、グループで整理すると管理しやすくなります（例: `認証`, `ユーザー管理`, `商品API`）
- **タグ機能**: 検索やフィルタリングに便利です（例: `smoke-test`, `regression`, `critical`, `bug-fix`）
- **お気に入り**: 頻繁に使うシナリオは⭐お気に入りに登録しましょう
- **テスト設定**: シナリオにデフォルトの Headers/Body を設定しておくと、API Test ページで毎回入力する手間が省けます
- **定数機能**: `$TIMESTAMP`や`$UUID`を使うと、毎回異なる値でテストできます
- **モック API 優先度**: 同じパスに複数のモック API がある場合、優先度の高いものが選択されます
- **シナリオのコピー**: 似たシナリオを作成する場合は、既存のシナリオをコピーして編集すると効率的です
- **JSON 形式**: データやレスポンスボディは有効な JSON 形式で入力してください
- **HTTP メソッド制限**: GET/DELETE/HEAD/OPTIONS メソッドではリクエストボディを送信できません（自動的に無効化されます）

## トラブルシューティング

### データベースに接続できない

ナビゲーションバーに🔴（未接続）と表示される場合：

1. データベース接続アイコンをクリックして設定画面を開く
2. データベース接続情報を確認
3. PostgreSQL サーバーが起動しているか確認
4. 接続情報が正しいか確認（ホスト、ポート、ユーザー名、パスワード、データベース名）
5. ネットワーク接続を確認

### シナリオ適用後にテーブルが作成できない

1. DDL 構文が正しいか確認
2. 依存関係の順序が正しいか確認（外部キーを持つテーブルは、参照先テーブルの後に作成）
3. 既に同名のテーブルが存在していないか確認
4. データベース接続が正常か確認

### シナリオ適用後にデータが投入されない

1. テーブルが既に存在しているか確認
2. JSON 形式が正しいか確認
3. カラム名とデータ型が一致しているか確認
4. 外部キー制約がある場合、親テーブルのデータを先に投入する必要があります
5. 「投入前にテーブルをクリア」オプションを確認

### モック API が動作しない

1. モック API のパスが正しいか確認してください
2. HTTP メソッドが一致しているか確認
3. パスパラメータを使用する場合は `:id` の形式で設定します（例: `/users/:id`）
4. ブラウザの開発者ツールでネットワークタブを確認し、リクエストが正しく送信されているか確認
5. モック API の優先度を確認（複数のモック API がマッチする場合、優先度が高いものが選択されます）
6. API Test ページの「Mock Logs」で実際のモックログを確認

### シナリオが再適用必要と表示される

シナリオを編集した場合、API Test ページで「**再適用が必要**」バッジが表示されます：

1. 「**適用**」ボタンをクリックして最新の状態を適用してください
2. これにより、テーブル、データ、モック API が最新の設定で再構築されます

### グループフィルターでシナリオが表示されない

1. グループフィルターが「すべて表示」になっているか確認
2. シナリオが正しいグループに属しているか確認
3. 検索ボックスにテキストが入力されていないか確認

### 定数が更新されない

1. API Test ページで「**定数を再変換**」ボタンをクリック
2. 定数は元のシナリオの設定から再生成されます
3. 手動で値を変更した場合は、再変換すると元の定数パターンに戻ります

### リクエストでボディが送信されない

1. HTTP メソッドが GET/DELETE/HEAD/OPTIONS でないか確認
2. これらのメソッドではボディタブが自動的に無効化されます
3. POST/PUT/PATCH メソッドを使用してください

## サポート

問題が解決しない場合は、開発チームにお問い合わせください。
